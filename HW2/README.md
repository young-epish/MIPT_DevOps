# MIPT 

---
## Homework 2

### Point 1 (Build)

Соберите Job, в котором будет собираться образ из предыдущего задания и заливаться в Container Registry на сайте https://gitlab.com. Для этого необходимо сделать следующие шаги:

1. Создайте репозиторий на сайте gitlab.com, в котором необходимо будет настроить CI.
2. Для настройки задания в Gitlab создайте файл `.gitlab-ci.yml`, в котором будет настроен pipeline для сборки.
3. Создайте файл `docker-compose.yml`, который соединяет в одну конфигурацию образы из предыдущего задания. Образы называем `nginx-customized`, `postgres-customized`.
4. Создайте job `build_images`, который соберет образы `nginx-customized` и `postgres-customized`. После сборки образа необходимо будет залить образы (`docker push`) в Registry сайта gitlab.com (вкладка в проекте `Deploy → Container Registry`). Для job используйте тег `gitlab-org-docker` для runner-а внутри job, который позволяет использовать команду docker для runner-ов на сайте gitlab.com.
5. Создайте файл `docker-compose-deploy.yaml` из файла `docker-compose.yaml`, в котором замените опции `build` внутри `services` на опцию `image` с собранными названиями образов в Docker Registry из шага 4.

### Point 2 (Deploy)

Создайте job `deploy_compose`, который будет делать следующие шаги:

1. Настроит SSH-соединение на сервер в пользователя studentXX по адресу master.hadoop.akhcheck.ru (46.XXX.XXX.XXX) (“виртуалка”).
2. По scp копирует файл docker-compose-deploy.yaml в файл docker-compose.yaml
3. Для каждого пользователя будет выделен порт 350XX для nginx. Для тестов дополнительно будет выделен порт 450XX для postgres.
4. Запустит команду `docker-compose up -d`. После корректного запуска команды по адресу http://master.hadoop.akhcheck.ru:350XX будет доступна страница nginx.

Получите статус Forbidden для сервера. Что в конфигурации было не так?

5. Догадайтесь, что было не так в изначальной сборке контейнера. Как сделать так, чтобы блокировались все запросы, кроме GET? (Изначально блокировались все, кроме POST)
6. Вы получили ошибку на сайте 404. Каким образом можно исправить эту ошибку? Посмотрите, что отправляется при запросе на сервер с заголовком `Host`. Это и будет ответом на изменение конфигурации NGINX.